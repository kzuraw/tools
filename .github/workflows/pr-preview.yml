name: Deploy PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup preview directory
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "PREVIEW_DIR=pr-$PR_NUMBER" >> $GITHUB_ENV

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Deploy preview to gh-pages
        run: |
          # Remove old preview if it exists
          rm -rf gh-pages/$PREVIEW_DIR

          # Create preview directory
          mkdir -p gh-pages/$PREVIEW_DIR

          # Copy files to preview directory (excluding .git and .github)
          rsync -av --exclude='.git' --exclude='.github' --exclude='gh-pages' . gh-pages/$PREVIEW_DIR/

          # Update index with PR preview link (optional)
          cd gh-pages
          if [ ! -f "pr-previews.html" ]; then
            cat > pr-previews.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>PR Previews</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      line-height: 1.6;
                  }
                  h1 {
                      color: #333;
                      border-bottom: 2px solid #007bff;
                      padding-bottom: 10px;
                  }
                  .preview-list {
                      list-style: none;
                      padding: 0;
                  }
                  .preview-list li {
                      margin: 15px 0;
                      padding: 15px;
                      background-color: #f8f9fa;
                      border-radius: 5px;
                  }
                  .preview-list a {
                      color: #007bff;
                      text-decoration: none;
                      font-weight: bold;
                  }
                  .preview-list a:hover {
                      text-decoration: underline;
                  }
              </style>
          </head>
          <body>
              <h1>PR Previews</h1>
              <ul class="preview-list" id="previews">
              </ul>
              <script>
                  // Dynamically list PR preview directories
                  fetch('.')
                      .then(() => {
                          const previewList = document.getElementById('previews');
                          // This is a placeholder - in a real scenario you'd need to list directories
                          previewList.innerHTML = '<li>PR previews are available at /pr-{number}/</li>';
                      });
              </script>
          </body>
          </html>
          EOF
          fi

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit and push
          git add .
          git commit -m "Deploy preview for PR #$PR_NUMBER" || echo "No changes to commit"
          git push origin gh-pages

      - name: Get Pages URL
        id: pages-url
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          REPO_OWNER="${{ github.repository_owner }}"
          echo "url=https://${REPO_OWNER}.github.io/${REPO_NAME}/pr-${{ env.PR_NUMBER }}/" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.pages-url.outputs.url }}';
            const prNumber = ${{ github.event.pull_request.number }};

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview deployed')
            );

            const body = `## ðŸš€ Preview deployed!

            Your PR preview is ready at:
            **${previewUrl}**

            The preview will update automatically when you push new commits.

            ---
            *Preview for commit: ${context.payload.pull_request.head.sha.substring(0, 7)}*`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }
